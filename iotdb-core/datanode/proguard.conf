# 关闭优化
-dontoptimize
-dontshrink

# 保留数据库入口类（如主启动类）

# 保留数据加密相关类和方法（避免反射失效）
-keep class org.apache.iotdb.commons.security.encrypt.** { *; }


# 保留序列化/反序列化类（如JSON解析）
-keepclassmembers class * implements java.io.Serializable {
    static final long serialVersionUID;
    private void writeObject(java.io.ObjectOutputStream);
    private void readObject(java.io.ObjectInputStream);
}

# 保留JDBC驱动类（如MySQL）
-keep class org.apache.iotdb.jdbc.** { *; }

# 保留本地方法
-keepclasseswithmembernames class * { native <methods>; }

# 排除对依赖库的混淆
-keep class org.apache.iotdb.db.audit.** {
    *;
}
-keep class org.apache.iotdb.db.auth.** {
    *;
}
-keep class org.apache.iotdb.db.conf.** {
    *;
}
-keep class org.apache.iotdb.db.consensus.** {
    *;
}
-keep class org.apache.iotdb.db.exception.** {
    *;
}
-keep class org.apache.iotdb.db.pipe.** {
    *;
}
-keep class org.apache.iotdb.db.protocol.** {
    *;
}
-keep class org.apache.iotdb.db.queryengine.** {
    *;
}
-keep class org.apache.iotdb.db.schemaengine.** {
    *;
}
-keep class org.apache.iotdb.db.service.** {
    *;
}
-keep class org.apache.iotdb.db.subscription.** {
    *;
}
-keep class org.apache.iotdb.db.tools.** {
    *;
}
-keep class org.apache.iotdb.db.trigger.** {
    *;
}
-keep class org.apache.iotdb.db.utils.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.* {
    *;
}
-keep class org.apache.iotdb.db.storageengine.buffer.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.load.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.rescon.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.* {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.flush.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.memtable.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.modification.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.read.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.snapshot.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.tsfile.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.utils.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.wal.** {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.execute.performer.constant.* {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.selector.constant.* {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.schedule.constant.* {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.constant.* {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.schedule.CompactionScheduleContext { *; }
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.settle.SettleTask { *; }
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.execute.task.CompactionTaskSummary { *; }
-keep class org.apache.iotdb.db.storageengine.dataregion.compaction.selector.utils.InsertionCompactionCandidateStatus { *; }
#除了compaction

# 生成映射文件，便于debug
-printmapping mapping.txt

# 忽略重复类警告
-dontwarn org.apache.iotdb.db.protocol.rest.**
-dontwarn module-info
-dontwarn jdk.internal.jimage.**
-dontwarn jdk.internal.jrtfs.**
-dontwarn org.apache.iotdb.db.protocol.rest.**
-dontwarn org.apache.iotdb.db.protocol.rest.v1.**
-dontwarn org.apache.iotdb.db.protocol.rest.v2.**
-dontwarn org.apache.iotdb.db.protocol.rest.table.v1.**
-dontwarn java.sql.Date

# Handle management interfaces
-dontwarn java.lang.management.**
-dontwarn com.sun.management.**

# Keep classes that use reflection
-keep class org.apache.iotdb.db.pipe.processor.twostage.exchange.payload.CombineRequest { *; }
-keep class org.apache.iotdb.db.pipe.agent.plugin.PipeDataNodePluginAgent { *; }
-keep class org.apache.iotdb.db.queryengine.plan.execution.config.executor.ClusterConfigTaskExecutor { *; }
-keep class org.apache.iotdb.db.schemaengine.schemaregion.SchemaRegionLoader { *; }
-keep class org.apache.iotdb.db.schemaengine.schemaregion.mtree.loader.MNodeFactoryLoader { *; }
-keep class org.apache.iotdb.db.service.ExternalRPCService { *; }
-keep class org.apache.iotdb.db.trigger.service.TriggerManagementService { *; }

# Keep dynamically accessed constructors
-keepclassmembers class * {
    public <init>(org.apache.iotdb.db.schemaengine.schemaregion.ISchemaRegionParams);
}

-dontwarn javax.persistence.**
-keep class javax.persistence.Entity

# 保留使用反射或动态加载的类
-keep class org.apache.iotdb.db.schemaengine.schemaregion.SchemaRegionLoader { *; }
-keep class org.apache.iotdb.db.schemaengine.schemaregion.mtree.loader.MNodeFactoryLoader { *; }
-keep class org.apache.iotdb.db.pipe.processor.twostage.exchange.payload.CombineRequest { *; }
-keep class org.apache.iotdb.db.pipe.agent.plugin.PipeDataNodePluginAgent { *; }
-keep class org.apache.iotdb.db.queryengine.plan.execution.config.executor.ClusterConfigTaskExecutor { *; }
-keep class org.apache.iotdb.db.service.ExternalRPCService { *; }
-keep class org.apache.iotdb.db.trigger.service.TriggerManagementService { *; }

# 保留注解处理器使用的类
-keepattributes RuntimeVisibleAnnotations
-keepattributes RuntimeInvisibleAnnotations